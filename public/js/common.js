$(document).ready(function(){$("#gyroViewer").gyroViewer();});$.fn.gyroViewer=function(options){var defaults={image:"images/06-small.jpg"};var options=$.extend(defaults,options);var viewer=$(this);var data={manualControl:false,longitude:0,latitude:0,savedLongitude:0,savedLatitude:0,savedX:0,savedY:0,winWidth:$(window).width(),winHeight:$(window).height(),viewerWidth:viewer.width(),viewerHeight:viewer.height(),resizeListener:null,direction:0,tiltFB:0,tiltLR:0,isIOS:(navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?true:false)};viewer.init=function(){viewer.build();viewer.render();viewer.bindEvents();};viewer.build=function(){viewer.html("").css("overflow","hidden");try{viewer.renderer=new THREE.WebGLRenderer();viewer.renderer.setSize(data.viewerWidth,data.viewerHeight);viewer.append(viewer.renderer.domElement);}catch(e){viewer.debug("WEBGL not supported");return false;}
viewer.scene=new THREE.Scene();viewer.camera=new THREE.PerspectiveCamera(75,data.viewerWidth/data.viewerHeight,1,1000);viewer.camera.target=new THREE.Vector3(0,0,0);viewer.sphere=new THREE.SphereGeometry(100,100,40);viewer.sphere.applyMatrix(new THREE.Matrix4().makeScale(-1,1,1));viewer.sphereMaterial=new THREE.MeshBasicMaterial();viewer.sphereMaterial.map=THREE.ImageUtils.loadTexture(options.image);viewer.sphereMesh=new THREE.Mesh(viewer.sphere,viewer.sphereMaterial);viewer.scene.add(viewer.sphereMesh);};viewer.render=function(){requestAnimationFrame(viewer.render);if(!data.manualControl&&!viewer.shouldUseGyro()){data.longitude+=0.1;}
data.latitude=Math.max(-85,Math.min(85,data.latitude));viewer.camera.target.x=500*Math.sin(THREE.Math.degToRad(90- data.latitude))*Math.cos(THREE.Math.degToRad(data.longitude));viewer.camera.target.y=500*Math.cos(THREE.Math.degToRad(90- data.latitude));viewer.camera.target.z=500*Math.sin(THREE.Math.degToRad(90- data.latitude))*Math.sin(THREE.Math.degToRad(data.longitude));viewer.camera.lookAt(viewer.camera.target);viewer.renderer.render(viewer.scene,viewer.camera);};viewer.bindEvents=function(){$(window).on("resize",viewer.resize);if(viewer.shouldUseGyro()){viewer.deviceOrientation=false;var promise=new FULLTILT.getDeviceOrientation({"type":"world"});promise.then(function(controller){viewer.deviceOrientation=controller;viewer.deviceOrientation.listen(viewer.onDeviceOrientation);}).catch(function(message){});}else{if(Modernizr.touch){viewer.on("touchstart",viewer.onMouseDown);}else{viewer.on("mousedown",viewer.onMouseDown);}
if(Modernizr.touch){viewer.on("touchmove",viewer.onMouseMove);}else{viewer.on("mousemove",viewer.onMouseMove);}
if(Modernizr.touch){viewer.on("touchstop",viewer.onMouseUp);}else{viewer.on("mouseup",viewer.onMouseUp);}}};viewer.onMouseDown=function(e){e.preventDefault();data.manualControl=true;var x=e.clientX||e.originalEvent.touches[0].clientX;var y=e.clientY||e.originalEvent.touches[0].clientY;data.savedX=x;data.savedY=y;data.savedLongitude=data.longitude;data.savedLatitude=data.latitude;};viewer.onMouseMove=function(e){if(data.manualControl){var x=e.clientX||e.originalEvent.touches[0].clientX;var y=e.clientY||e.originalEvent.touches[0].clientY;data.longitude=(data.savedX- x)*0.1+ data.savedLongitude;data.latitude=(y- data.savedY)*0.1+ data.savedLatitude;}};viewer.onMouseUp=function(e){data.manualControl=false;};viewer.onDeviceOrientation=function(e){var e=viewer.deviceOrientation.getScreenAdjustedEuler();data.direction=Math.round(e.alpha);data.tiltFB=Math.round(e.beta);data.tiltLR=Math.round(e.gamma);viewer.debug(data.direction+","+data.tiltFB+","+data.tiltLR);if(data.tiltFB<0){data.tiltFB=data.tiltFB*-1;}
data.latitude=(data.tiltFB)-(180/2);var alphaRad=e.alpha*(Math.PI/180);var betaRad=e.beta*(Math.PI/180);var gammaRad=e.gamma*(Math.PI/180);var cA=Math.cos(alphaRad);var sA=Math.sin(alphaRad);var cB=Math.cos(betaRad);var sB=Math.sin(betaRad);var cG=Math.cos(gammaRad);var sG=Math.sin(gammaRad);var rA=- cA*sG- sA*sB*cG;var rB=- sA*sG+ cA*sB*cG;var rC=- cB*cG;var compassHeading=Math.atan(rA/rB);if(rB<0){compassHeading+=Math.PI;}else if(rA<0){compassHeading+=2*Math.PI;}
compassHeading*=180/Math.PI;data.longitude=compassHeading;};viewer.resize=function(){clearTimeout(data.resizeListener);data.resizeListener=setTimeout(function(){viewer.afterResize();},500);};viewer.afterResize=function(){data.winWidth=$(window).width();data.winHeight=$(window).height();data.viewerWidth=viewer.width();data.viewerHeight=viewer.height();viewer.build();};viewer.shouldUseGyro=function(){if(viewer.hasOrientation()&&Modernizr.touch){return true;}else{return false;}};viewer.hasOrientation=function(){if(window.DeviceOrientationEvent||window.OrientationEvent||typeof(window.onorientationchange)!="undefined"){return true;}else{return false;}};viewer.onImageLoaded=function(src,callback){var img=new Image();img.onLoad=function(){if(typeof(callback)=="function"){callback(img);}};img.src=src;};viewer.debug=function(string){console.log(string);};return this.each(function(){viewer.init();});};
